# Glob

env:
  - CABALVER=1.22 GHCVER=7.10.3
services:
  - docker

before_install:
  - docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  - "sudo add-apt-repository -y ppa:hvr/ghc"
  - "sudo apt-get update"
  - "sudo apt-get -y install ghc-$GHCVER cabal-install-$CABALVER"
  - "export PATH=/opt/ghc/$GHCVER/bin:/opt/cabal/$CABALVER/bin:$PATH"
  - "cabal update"
  - "cabal install -j9 directory process persistent-template yesod persistent-postgresql persistent-mongoDB warp-tls cmdargs SHA"
script:
  - cabal configure -flaunch-docker -fwith-postgresql
  - cabal build
  - cabal sdist
  - cabal install dist/Glob-*.tar.gz -fwith-postgresql
  - cabal install dist/Glob-*.tar.gz -fwith-mongodb
  - cabal install dist/Glob-*.tar.gz -flaunch-docker -flaunch-simple -fwith-postgresql && mkdir dsp && cp -r dist dsp
  - cabal install dist/Glob-*.tar.gz -fwith-tls -fwith-postgresql -flaunch-docker -flaunch-simple && mkdir dspt && cp -r dist dspt
  - cabal install dist/Glob-*.tar.gz -flaunch-docker -flaunch-simple -fwith-mongodb && mkdir dsm && cp -r dist dsm
  - cabal install dist/Glob-*.tar.gz -fwith-tls -fwith-mongodb -flaunch-docker -flaunch-simple && mkdir dsmt && cp -r dist dsmt
after_script: |
  if [ $TRAVIS_TEST_RESULT -eq 0 ]; then
    echo "There should build a docker image."
    rm -rf dist
    if [ -n "$TRAVIS_TAG" ]; then
      export DOCKER_IMAGE_TAG=$TRAVIS_TAG-$TRAVIS_BUILD_NUMBER
    else
      export DOCKER_IMAGE_TAG=$TRAVIS_COMMIT-$TRAVIS_BUILD_NUMBER
    fi
    cp ./dockerfiles/Travis-CI/PostgreSQL/Dockerfile dsp
    cp ./dockerfiles/Travis-CI/PostgreSQL/Dockerfile dspt
    cp ./dockerfiles/Travis-CI/MongoDB/Dockerfile dsm
    cp ./dockerfiles/Travis-CI/MongoDB/Dockerfile dsmt
    cd dsp && docker build -f Dockerfile -t qinka/glob:postgresql-$DOCKER_IMAGE_TAG . && cd ..
    cd dspt && docker build -f Dockerfile -t qinka/glob:tls-postgresql-$DOCKER_IMAGE_TAG . && cd ..
    cd dsm && docker build -f Dockerfile -t qinka/glob:mongodb-$DOCKER_IMAGE_TAG . && cd ..
    cd dsmt && docker build -f Dockerfile -t qinka/glob:tls-mongodb-$DOCKER_IMAGE_TAG . && cd ..
    docker push  qinka/glob
  fi
